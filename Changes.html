<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=windows-1250">
  <meta name="generator" content="PSPad editor, www.pspad.com">
  <title>Erweiterte Umfrage 1.3 - &Auml;nderungen durch das Modul</title>
  <style type="text/css">
  <!--
  ul { font-weight: bold; margin-left: 0px; }
  li { font-weight: normal; margin-left: 35px; }
  pre { background-color: #D9D9D9; }
  .HDNormal { background-color: #D9D9D9; }
  .HDDeleted {  color: #009100; background:  #FFA400; text-decoration:line-through ; font-family: Courier New ; font-size: 10pt;}
  .HDAdded {  color: #000000; background:  #FFFF3E; text-decoration:none ; font-family: Courier New ; font-size: 10pt;}
  -->
  </style>
  </head>
  <body>
  <h3>Erweiterte Umfrage 1.3 - &Auml;nderungen durch das Modul</h3>
  <b>MYSQL:</b><br>
  <pre>ALTER TABLE `<i>prefix</i>_poll` ADD `user_rechte` VARCHAR( 10 ), ADD `groups` VARCHAR( 255 ) NOT NULL, ADD `view` TINYINT( 2 ) NOT NULL DEFAULT '0', ADD `exptime` INT ( 10 ) NOT NULL DEFAULT '0' ;</pre>
  <h4>Hier sind die Änderungen an den einzelnen Dateien aufgelistet,
  dies wurde mit dem Programm <a href="http://www.componentsoftware.com/Products/csdiff/download.htm">CSDiff 5.0</a> bewerkstelligt.</h4>
  <ul>Ver&auml;nderte Dateien:
    <li><a href="#admin">include/boxes/vote.php</a></li>
    <li><a href="#content">include/contents/vote.php</a></li>
    <li><a href="#box">include/admin/vote.php</a></li>
  </ul>
  <span class="HDNormal">unverändert</span> &nbsp; <span class="HDAdded">eingefügt</span> &nbsp; <span class="HDDeleted">entfernt</span>
  <br><br>
  <b><a name="#admin">include/admin/vote.php</a></b>
  <pre><span class="HDNormal">&lt;?php 
#   Copyright by: Manuel Staechele
#   Support: www.ilch.de
<a name="diff" id="c0"><span class="HDAdded">#   Modified by Mairu -&gt; Erweiterte Umfrage 1.3
#   include/admin/vote.php
</span></a>

defined ('main') or die ( 'no direct access' );
defined ('admin') or die ( 'only admin access' );

$design = new design ( 'Admins Area', 'Admins Area', 2 );
$design-&gt;header();

function showVote ($id) {
  
    $maxRow = db_fetch_object(db_query('SELECT MAX(res) as res FROM `prefix_poll_res` WHERE poll_id = "'.$id.'"'));
    $gesRow = db_fetch_object(db_query('SELECT SUM(res) as res FROM `prefix_poll_res` WHERE poll_id = "'.$id.'"'));
    $max = $maxRow-&gt;res;
  $ges = $gesRow-&gt;res;
    $erg = db_query('SELECT antw, res FROM `prefix_poll_res` WHERE poll_id = "'.$id.'" ORDER BY sort');
    while ($row = db_fetch_object($erg)) {
      if ( !empty($row-&gt;res) ) {  
          $weite = ($row-&gt;res / $max) * 200;
          $prozent = $row-&gt;res * 100 / $ges;
          $prozent = round($prozent,0);
        } else {
          $weite = 0;
            $prozent = 0;
        }      
    echo '&lt;tr&gt;&lt;td width="30%"&gt;'.$row-&gt;antw.'&lt;/td&gt;';
    echo '&lt;td width="50%"&gt;&lt;hr width="'.$weite.'" align="left"&gt;&lt;/td&gt;';
        echo '&lt;td width="10%"&gt;'.$prozent.'%&lt;/td&gt;';
        echo '&lt;td width="20%" align="right"&gt;'.$row-&gt;res.'&lt;/td&gt;&lt;/tr&gt;';
            
  }
    echo '&lt;tr&gt;&lt;td colspan="4" align="right"&gt;Gesamt: &amp;nbsp; '.$ges.'&lt;/td&gt;&lt;/tr&gt;';
}

function getPollRecht ( $akt ) {

  $liste = '';
  $ar = array ( 1 =&gt; 'alle' , 2 =&gt; 'registrierte' );
  foreach ($ar as $k =&gt; $v ) {
      if ($akt == $k ) {
          $sel = ' selected';
        } else {
          $sel = '';
        }
        $liste .= '&lt;option'.$sel.' value="'.$k.'"&gt;'.$v.'&lt;/option&gt;';
    }
    return ($liste);
}
<a name="diff" id="c1"><span class="HDDeleted">
</span></a>$um = $menu-&gt;get(1);
if ( $menu-&gt;get(1) == 'del' ) {
      db_query('DELETE FROM `prefix_poll` WHERE poll_id = "'.$_GET['del'].'"');
        db_query('DELETE FROM `prefix_poll_res` WHERE poll_id = "'.$_GET['del'].'"');
}
if ( $menu-&gt;get(1) == 5 ) {
      db_query('UPDATE `prefix_poll` SET stat = "'.$_GET['ak'].'" WHERE poll_id = "'.$_GET['id'].'"');
}

<a name="diff" id="c2"><span class="HDAdded">//Gruppen auslesen
</span></a><span class="HDAdded">      $groups = array();
</span><span class="HDAdded">            $erg3 = db_query('SELECT id, name FROM prefix_groups');
</span><span class="HDAdded">      $i = 0;
</span><span class="HDAdded">      while ($row3 = db_fetch_object($erg3)) {
</span><span class="HDAdded">      $groups[$i]['id'] = $row3-&gt;id;
</span><span class="HDAdded">      $groups[$i]['name'] = $row3-&gt;name;
</span><span class="HDAdded">      $groups[$i]['checked'] = '';
</span>    <span class="HDAdded">  $i++;       </span>
    <span class="HDAdded">  }    </span>
    
// A L L E   V O T E S   W E R D E N   A N G E Z E I G T            
  
<a name="diff" id="c3"><span class="HDAdded">    //Datum und Zeit auslesen
    if ( isset($_POST['datum'])  AND preg_match('/\d\d.\d\d.\d\d\d\d/',$_POST['datum']) == 1 ) {
      $d = explode('.',$_POST['datum']);
      if (checkdate($d[1],$d[0],$d[2])) {
        $datum = $_POST['datum'];
        if ( isset($_POST['zeit'])  AND preg_match('/\d\d:\d\d/',$_POST['zeit']) == 1 ) {
          $h = intval(substr($_POST['zeit'],0,2));
          $m = intval(substr($_POST['zeit'],2));
          if ( $h &gt;= 0 AND $h &lt; 24 AND $m &gt;= 0 AND $m &lt; 60) {
            $zeit = $_POST['zeit'];
          }
        } else {
          $zeit = '00:00';
        }
      } 
    } else {
      $datum = '';
      $zeit = '';
    }
</span></a>
    if ( isset($_POST['sub']) ) {
<a name="diff" id="c4"><span class="HDAdded">      
      $grps = '';
      $usr = '';
      $view = 0;
      if ($_POST['poll_recht'] &gt; 1) {
      foreach($groups as $id =&gt; $group) if ($_POST['cb_gr'.$group['id']] == 'on') $grps .='#'.$group['id'];    
      for ($i = 1; $i &lt;= 9; $i++ ) if ($_POST['cb'.$i] == 'on') $usr .= $i;
            $view = escape($_POST['view'],'integer');
      }
      if ($datum != '') {
        $timestamp = mktime( substr($zeit,0,2), substr($zeit,3) , 0, substr($datum,3,2) , substr($datum,0,2) , substr($datum,6) );
      } else {
        $timestamp = 0;
      }      
</span></a>        if ( empty($_POST['vid']) ) {
            db_query('INSERT INTO `prefix_poll` VALUES ( "" , "'.$_POST['frage'].'" , "'.$_POST['poll_recht'].'" , "1" , "" <a name="diff" id="c5"><span class="HDDeleted">) ' </span></a><span class="HDAdded">, "'.$usr.'", "'.$grps.'", '.$view.', '.$timestamp.') '</span>);
              $poll_id = db_last_id(); $i = 1;
              foreach ($_POST['antw'] as $v) {
                if ( ! empty ($v) ) {
                   db_query('INSERT INTO `prefix_poll_res` VALUES ( "'.$i.'" , "'.$poll_id.'" , "'.$v.'" , "" ) ' );
             $i++;
                  }
            }
          } else {
        db_query('UPDATE `prefix_poll` SET frage = "'.$_POST['frage'].'", recht = "'.$_POST['poll_recht'].'"<a name="diff" id="c6"><span class="HDAdded">, user_rechte = "'.$usr.'", groups = "'.$grps.'", view = '.$view.', exptime = '.$timestamp.'</span></a> WHERE poll_id = "'.$_POST['vid'].'"');
              $i = 1;
                foreach ($_POST['antw'] as $k =&gt; $v) {
                  $a = db_count_query("SELECT COUNT(*) FROM prefix_poll_res WHERE poll_id = ".$_POST['vid']." AND sort = ".$k);
                    if ( $a == 0 AND $v != '' ) {
                      db_query ("INSERT INTO `prefix_poll_res` VALUES ( '".$i."' , '".$_POST['vid']."' , '".$v."' , '' )");
                        $i++;
                    } elseif ( $a == 1 AND $v == '' ) {
                      db_query ("DELETE FROM `prefix_poll_res` WHERE poll_id = ".$_POST['vid']." AND sort = ".$k);
                    } elseif ( $a == 1 AND $v != '' ) {
                      db_query ("UPDATE `prefix_poll_res` SET antw = '".$v."', sort = ".$i." WHERE poll_id = ".$_POST['vid']." AND sort = ".$k);
                        $i++;
                    }
                }
      }
<a name="diff" id="c7"><span class="HDAdded">        $datum = '';
        $zeit = '';
</span></a>        } 
        if ( empty($_POST['add']) ) {
<a name="diff" id="c8"><span class="HDAdded">        
</span></a>            if ( isset($_GET['vid']) ) {
              $row1 = db_fetch_object(db_query('SELECT frage, recht<a name="diff" id="c9"><span class="HDAdded">, user_rechte, groups, view, exptime</span></a> FROM `prefix_poll` WHERE poll_id = "'.$_GET['vid'].'"'));
                $_POST['frage'] = $row1-&gt;frage;
                $_POST['poll_recht'] = $row1-&gt;recht;
<a name="diff" id="c10"><span class="HDAdded">                for ($i = 1; $i &lt;= 9; $i++) if (!is_bool(strrpos($row1-&gt;user_rechte,''.$i.''))) $_POST['cb'.$i] = 'on';
        foreach (explode('#', $row1-&gt;groups) as $group) $_POST['cb_gr'.$group['id']] = 'on';
</span></a>                $_POST['antw'] = array();
                $erg2 = db_query('SELECT sort,antw FROM `prefix_poll_res` WHERE poll_id = "'.$_GET['vid'].'" ORDER BY sort');
              while ($row2 = db_fetch_object($erg2)) {
                    $_POST['antw'][$row2-&gt;sort] = $row2-&gt;antw;
                }
<a name="diff" id="c11"><span class="HDAdded">                if ($row1-&gt;exptime &gt; 0) {
        $datum = date('d.m.Y',$row1-&gt;exptime);
        $zeit = date('H:i',$row1-&gt;exptime);
        } 
</span></a>                $_POST['vid'] = $_GET['vid'];
            } else {
              $_POST['frage'] = '';
                $_POST['antw'] = array(1=&gt;'');
                $_POST['poll_recht'] = <a name="diff" id="c12"><span class="HDDeleted">''</span></a><span class="HDAdded">1</span>;
                $_POST['vid'] = '';
            }
        }
            $anzFeld = count($_POST['antw']);
            if ( isset ($_POST['add']) ) {
              $anzFeld++;
                $_POST['antw'][] = '';
            }
            
<a name="diff" id="c13"><span class="HDAdded">      if ( isset($_GET['vid']) OR !empty($_POST['add'])) {
      foreach($groups as $id =&gt; $group) if ($_POST['cb_gr'.$group['id']] == 'on') $groups[$id]['checked'] = 'checked="checked"';
      for ($i = 1; $i &lt;= 9; $i++) {
        if ($_POST['cb'.$i] == 'on') $cb_u[$i] = 'checked="checked" ';
        else $cb_u[$i] = ' ';
        }
            }
            
            $display = ($_POST['poll_recht'] == 1?'none':'');
                
            echo
'&lt;script type="text/javascript"&gt;
function show_trs () {
  if (document.getElementById("tr1").style.display == "none") {
    document.getElementById("tr1").style.display = "";
    document.getElementById("tr2").style.display = "";
    document.getElementById("tr3").style.display = "";
  } else {
    document.getElementById("tr1").style.display = "none";
    document.getElementById("tr2").style.display = "none";
    document.getElementById("tr3").style.display = "none";
  }
}      
&lt;/script&gt;';
                                    
</span></a>            echo '&lt;form action="admin.php?vote" method="POST"&gt;';
            echo '&lt;input type="hidden" name="vid" value="'.$_POST['vid'].'" /&gt;';
      echo '&lt;table cellpadding="0" cellspacing="0" border="0"&gt;&lt;tr&gt;&lt;td&gt;&lt;img src="include/images/icons/admin/vote.png" /&gt;&lt;/td&gt;&lt;td width="30"&gt;&lt;/td&gt;&lt;td valign="bottom"&gt;&lt;h1&gt;Umfrage&lt;/h1&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';
      
            echo '&lt;table width="100%" cellpadding="2" cellspacing="1" border="0" class="border"&gt;';
          echo '&lt;tr&gt;&lt;td width="1<a name="diff" id="c14"><span class="HDDeleted">00</span></a><span class="HDAdded">55</span>" class="Cmite"&gt;Frage&lt;/td&gt;';
          echo '&lt;td width="500" class="Cnorm"&gt;&lt;input type="text" size="<span class="HDDeleted">40</span><span class="HDAdded">74</span>" value="'.$_POST['frage'].'" name="frage"&gt;&lt;/td&gt;&lt;/tr&gt;';
          echo '&lt;tr&gt;&lt;td <span class="HDDeleted">width="100" </span>class="Cmite"&gt;<span class="HDDeleted">F&amp;uuml;r</span><span class="HDAdded">Umfrage l&amp;auml;uft aus am:&lt;br /&gt;&lt;small&gt;Wenn nicht angegeben, l&amp;auml;uft sie nie von alleine aus&lt;/small&gt;</span>&lt;/td&gt;';
<span class="HDDeleted">          </span><span class="HDAdded">      </span>echo '&lt;td <span class="HDDeleted">width="500" </span>class="Cnorm"&gt;<span class="HDDeleted">&lt;select name="poll_recht"&gt;'. getPollRecht($_POST['poll_recht']) .'&lt;/select&gt;&lt;/</span><span class="HDAdded">Datum (Format: DD.MM.YYYY) &lt;input type="text" value="'.$datum.'" name="datum" size="10"/&gt; &amp;nbsp; Zeit: (Format HH:MM) &lt;input type="text" value="'.$zeit.'" name="zeit" size="5"/&gt;&lt;/</span>td&gt;&lt;/tr&gt;';<span class="HDAdded">      </span>
<span class="HDAdded">      echo '&lt;tr&gt;&lt;td class="Cmite"&gt;F&amp;uuml;r&lt;/td&gt;';
          echo '&lt;td width="500" class="Cnorm"&gt;&lt;select name="poll_recht" onchange="show_trs();"&gt;'. getPollRecht($_POST['poll_recht']) .'&lt;/select&gt;&lt;/td&gt;&lt;/tr&gt;';
            
      echo '&lt;tr id="tr1" style="display: '.$display.';"&gt;&lt;td class="Cmite"&gt;Userklassen&lt;font class="smalfont"&gt;&lt;br /&gt;Wenn keiner ausgewählt ist können alle voten&lt;/font&gt;&lt;/td&gt;&lt;td class="Cnorm"&gt;'.
      
      '&lt;table border="0" cellpadding="0" cellspacing="0"&gt;&lt;tr&gt;'.
      '&lt;td&gt;&lt;input type="checkbox" name="cb1"'.$cb_u[1].'/&gt;User&lt;/td&gt;'.
      '&lt;td&gt;&lt;input type="checkbox" name="cb2"'.$cb_u[2].'/&gt;Superuser&lt;/td&gt;'.
      '&lt;td&gt;&lt;input type="checkbox" name="cb3"'.$cb_u[3].'/&gt;Trialmember&lt;/td&gt;'.
      '&lt;td&gt;&lt;input type="checkbox" name="cb4"'.$cb_u[4].'/&gt;Member&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;'.
      '&lt;td&gt;&lt;input type="checkbox" name="cb5"'.$cb_u[5].'/&gt;CoLeader&lt;/td&gt;'.
      '&lt;td&gt;&lt;input type="checkbox" name="cb6"'.$cb_u[6].'/&gt;Leader&lt;/td&gt;'.
      '&lt;td&gt;&lt;input type="checkbox" name="cb7"'.$cb_u[7].'/&gt;SiteAdmin&lt;/td&gt;'.
      '&lt;td&gt;&lt;input type="checkbox" name="cb8"'.$cb_u[8].'/&gt;CoAdmin&lt;/td&gt;'.
      '&lt;td&gt;&lt;input type="checkbox" name="cb9"'.$cb_u[9].'/&gt;Admin&lt;/td&gt;'.
      '&lt;/tr&gt;&lt;/table&gt;
      &lt;/td&gt;&lt;/tr&gt;
      &lt;tr id="tr2" style="display: '.$display.';"&gt;&lt;td class="Cmite"&gt;Ergebnis für andere sichtbar ab:&lt;/td&gt;&lt;td class="Cnorm"&gt;
      &lt;select name="view"&gt;'.dblistee($row1-&gt;view,'SELECT id,name FROM `prefix_grundrechte` ORDER BY id DESC').'&lt;/select&gt;
      &lt;/td&gt;&lt;/tr&gt;';
      
      echo '&lt;tr id="tr3" style="display: '.$display.';"&gt;&lt;td class="Cmite"&gt;Gruppen&lt;font class="smalfont"&gt;&lt;br /&gt;Wenn keiner ausgewählt ist können alle voten&lt;/font&gt;&lt;/td&gt;&lt;td class="Cnorm"&gt;&lt;table&gt;&lt;tr&gt;';
      $spalten = 0;
      foreach($groups as $group) {
        if ($spalten &gt;= 4) {
          $spalten = 1;
          echo '&lt;/tr&gt;&lt;/tr&gt;';      
        }
        else $spalten++;
        echo '&lt;td&gt;&lt;input type="checkbox" name="cb_gr'.$group['id'].'" '.$group['checked'].' /&gt;'.$group['name'].'&lt;/td&gt;';
      }
      echo '&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;';
            
      
</span>            for ($i=1;$i&lt;=$anzFeld; $i++) {
                echo '&lt;tr&gt;&lt;td class="Cmite"&gt;Antwort '.$i.'&lt;/td&gt;&lt;td class="Cnorm"&gt;';
              echo '&lt;input type="text" value="'.$_POST['antw'][$i].'" size="40" name="antw['.$i.']"&gt;';
              if ( $i == $anzFeld ) {
              echo ' &amp;nbsp; &lt;input type="submit" name="add" value="Antwort hinzuf&amp;uuml;gen"&gt;';
              }
              echo '&lt;/td&gt;&lt;/tr&gt;'."\n";
          }
          echo '&lt;tr class="Cdark"&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;input name="sub" type="submit" value="'.$lang['formsub'].'"&gt;&lt;/td&gt;&lt;/tr&gt;';
          echo '&lt;/table&gt;&lt;/form&gt;'; 
          echo '&lt;table width="100%" cellpadding="3" cellspacing="1" border="0" class="border"&gt;'; 
          echo '&lt;tr class="Chead"&gt;&lt;td colspan="5"&gt;&lt;b&gt;Vote verwalten&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;';
            ?&gt;
&lt;script language="JavaScript" type="text/javascript"&gt;
    &lt;!--
      
            function delcheck ( DELID ) {
              var frage = confirm ( "Willst du diesen Eintrag wirklich löschen?" );
                if ( frage == true ) {
                  document.location.href="?vote-del&amp;del="+DELID;
                }
            }
        //--&gt;
&lt;/script&gt;
            &lt;?php
            
            $abf = 'SELECT * FROM `prefix_poll` ORDER BY poll_id DESC';
          $erg = db_query($abf); $class = '';
      while ($row = db_fetch_object($erg)) {
        if ($row-&gt;stat == 1) {
                $coo = 'schliesen';
                  $up = 0;
            } else {
                $coo = '&amp;ouml;ffnen';
                $up = 1;
            }
              if ( $class == 'Cmite' ) { $class = 'Cnorm'; } else { $class = 'Cmite'; }
              echo '&lt;tr class="'.$class.'"&gt;';
              echo '&lt;td&gt;&lt;a  href="javascript:delcheck('.$row-&gt;poll_id.')"&gt;l&amp;ouml;schen&lt;/a&gt;&lt;/td&gt;';
                echo '&lt;td&gt;&lt;a href="?vote=0&amp;vid='.$row-&gt;poll_id.'"&gt;&amp;auml;ndern&lt;/a&gt;&lt;/td&gt;';
              echo '&lt;td&gt;&lt;a href="?vote-5=0&amp;ak='.$up.'&amp;id='.$row-&gt;poll_id.'"&gt;'.$coo.'&lt;/a&gt;&lt;/td&gt;';             
              echo '&lt;td&gt;&lt;a href="?vote=0&amp;showVote='.$row-&gt;poll_id.'"&gt;zeigen&lt;/a&gt;&lt;/td&gt;';
              echo '&lt;td&gt;'.$row-&gt;frage.'&lt;/td&gt;';
              echo '&lt;/tr&gt;';
            if ( isset($_GET['showVote']) AND $_GET['showVote'] == $row-&gt;poll_id ) {
                echo '&lt;tr class="'.$class.'"&gt;&lt;td colspan="5"&gt;';
                  echo '&lt;table width="90%" cellpadding="0" border="0" cellspacing="0" align="right"&gt;';
                  showVote( $row-&gt;poll_id);
                  echo '&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;';
              }
          }
          echo '&lt;/table&gt;';

$design-&gt;footer();
?&gt;</span></pre>
  <br><b><a name="#content">include/contents/vote.php</a></b>
  <pre><span class="HDNormal">&lt;?php 
#   Copyright by: Manuel Staechele
#   Support: www.ilch.de
<a name="diff" id="c0"><span class="HDAdded">#   Modified by Mairu -&gt; Erweiterte Umfrage 1.3
#   include/contents/vote.php
</span></a>

defined ('main') or die ( 'no direct access' );




//-----------------------------------------------------------|


##
###
####
##### ins vote
$um = $menu-&gt;get(1);
if ($menu-&gt;getA(1) == 'W') {

  $poll_id = escape ($menu-&gt;getE(1), 'integer');
    $radio = escape ($_POST['radio'], 'integer');
    
        $fraRow = db_fetch_object(db_query("SELECT * FROM prefix_poll WHERE poll_id = '".$poll_id."'"));
<a name="diff" id="c1"><span class="HDAdded">      if ($fraRow-&gt;exptime != 0 AND $fraRow-&gt;exptime &lt; time()) {
      db_query("UPDATE `prefix_poll` SET stat = 0 WHERE poll_id = $poll_id");
    } else { 
</span></a>      $textAr = explode('#',$fraRow-&gt;text);
      if ($fraRow-&gt;recht == 2) {
          $inTextAr = $_SESSION['authid'];
        } elseif ($fraRow-&gt;recht == 1) {
          $inTextAr = $_SERVER['REMOTE_ADDR'];
        }
        if ( !in_array ( $inTextAr , $textAr ) ) {
            $textAr[] = $inTextAr;
          $textArString = implode('#',$textAr);
      db_query('UPDATE `prefix_poll` SET text = "'.$textArString.'" WHERE poll_id = "'.$poll_id.'"');
          db_query('UPDATE `prefix_poll_res` SET res = res + 1 WHERE poll_id = "'.$poll_id.'" AND sort = "'.$radio.'" LIMIT 1') or die (db_error());
        }
        <a name="diff" id="c2"><span class="HDAdded">}</span></a>
}

##
###
####
##### V o t e    Ü b e r s i c h t 

$title = $allgAr['title'].' :: '.$lang['vote'];
$hmenu = $lang['vote'];
$design = new design ( $title , $hmenu );
$design-&gt;header();

?&gt;
&lt;table width="100%" cellpadding="2" cellspacing="1" border="0" class="border"&gt;
  &lt;tr class="Chead"&gt;
    &lt;td&gt;&lt;b&gt;&lt;?php $lang['vote']; ?&gt;&lt;/b&gt;&lt;/td&gt;
  &lt;/tr&gt;
    
&lt;?php

$breite = 200;
if ($_SESSION['authright'] &lt;= -1 ) {
      $woR = '&gt;= "1"';
} else {
      $woR = '= "1"';
}
$limit = <a name="diff" id="c3"><span class="HDDeleted">3;  // Limit </span></a><span class="HDAdded">5;  // Limit</span>
<span class="HDAdded">$zaehler = 0;
</span>$page = ( $menu-&gt;getA(1) == 'p' ? $menu-&gt;getE(1) : 1 );
$MPL = db_make_sites ($page , <a name="diff" id="c4"><span class="HDDeleted">'WHERE recht '.$woR</span></a><span class="HDAdded">''</span> , $limit , "?vote" , 'poll' );
$anfang = ($page - 1) * $limit;
$class = '';
$erg = db_query('SELECT * FROM `prefix_poll` <a name="diff" id="c5"><span class="HDDeleted">WHERE recht '.$woR.' ORDER BY </span></a><span class="HDAdded">ORDER BY stat DESC, </span>poll_id DESC LIMIT '.$anfang.',<span class="HDDeleted">'.$limit</span><span class="HDAdded">10000000'</span>);
while ($<span class="HDAdded">zaehler &lt; $limit AND $</span>fraRow = db_fetch_object($erg)) {

    $maxRow = db_fetch_object(db_query('SELECT MAX(res) as res FROM `prefix_poll_res` WHERE poll_id = "'.$fraRow-&gt;poll_id.'"'));
    $gesRow = db_fetch_object(db_query('SELECT SUM(res) as res FROM `prefix_poll_res` WHERE poll_id = "'.$fraRow-&gt;poll_id.'"'));
    $max = $maxRow-&gt;res;
  $ges = $gesRow-&gt;res;
    $textAr = explode('#',$fraRow-&gt;text);
    
      if ($fraRow-&gt;recht == 2) {
          $inTextAr = $_SESSION['authid'];
        } elseif ($fraRow-&gt;recht == 1) {
          $inTextAr = $_SERVER['REMOTE_ADDR'];
        }
<span class="HDDeleted">    echo '&lt;tr&gt;</span>&lt;td class="Cdark"&gt;<a name="diff" id="c6"><span class="HDDeleted">&lt;b&gt;'.$fraRow-&gt;frage.'&lt;/b&gt;</span></a>&lt;/td&gt;<span class="HDDeleted">&lt;/tr&gt;';
</span><a name="diff" id="c7"><span class="HDAdded">        
</span></a><span class="HDAdded">    
    if ($fraRow-&gt;user_rechte == '') $fraRow-&gt;user_rechte = '0123456789';
        if (!empty($fraRow-&gt;groups)) {
      $votegroups = explode('#', $fraRow-&gt;groups);
          foreach ($_SESSION['authgrp'] as $id =&gt; $authgroup) if (in_array($id, $votegroups)) $abstimmen = true;
          if (strpos($fraRow-&gt;user_rechte,''.abs($_SESSION['authright'])) === false) $abstimmen = false;
    }
    elseif (strpos($fraRow-&gt;user_rechte,''.abs($_SESSION['authright'])) !== false) $abstimmen = true;
    else $abstimmen = false;
    
    if (( in_array ( $inTextAr , $textAr ) OR $fraRow-&gt;stat == 0) OR (!$abstimmen)) {
            $imPollArrayDrin = true;
        } elseif ($abstimmen) {
            $imPollArrayDrin = false;
        }
    
    if (!$imPollArrayDrin OR $fraRow-&gt;view &gt;= $_SESSION['authright']) {
    $zaehler++; 
    echo '&lt;tr&gt;&lt;td class="Cdark"&gt;&lt;b&gt;'.$fraRow-&gt;frage.'&lt;/b&gt;';
    if ($fraRow-&gt;stat == 0 ) { echo ' (geschlossen)'; }
    elseif ($fraRow-&gt;exptime &gt; 0) { echo ' (bis '.date('H.i \U\h\r - d.m.Y',$fraRow-&gt;exptime).')'; }
    echo '&lt;/td&gt;&lt;/tr&gt;';
</span>        if ( $class == 'Cnorm' ) { $class = 'Cmite'; } else { $class = 'Cnorm'; }
        echo '&lt;tr&gt;&lt;td class="'.$class.'"&gt;';
<a name="diff" id="c8"><span class="HDDeleted">        if ( in_array ( $inTextAr , $textAr ) OR $fraRow-&gt;stat == 0) {
</span></a><span class="HDAdded">
</span><span class="HDAdded">        if ($imPollArrayDrin) {
</span>              echo '&lt;table width="100%" cellpadding="0"&gt;';
<a name="diff" id="c9"><span class="HDDeleted">            $imPollArrayDrin = true;
</span></a>        } else {
              echo '&lt;form action="index.php?vote-W'.$fraRow-&gt;poll_id.'" method="POST"&gt;';
<a name="diff" id="c10"><span class="HDDeleted">            $imPollArrayDrin = false;
</span></a>        }
<a name="diff" id="c11"><span class="HDAdded">
</span></a>    $i = 0;
        $pollErg = db_query('SELECT antw, res, sort FROM `prefix_poll_res` WHERE poll_id = "'.$fraRow-&gt;poll_id.'" ORDER BY sort');
        while ( $pollRow = db_fetch_object($pollErg) ) {
            if ( $imPollArrayDrin ) {
                 if ( !empty($pollRow-&gt;res) ) {  
                      $weite = ($pollRow-&gt;res / $max) * 200;
                      $prozent = $pollRow-&gt;res * 100 / $ges;
                      $prozent = round($prozent,0);
                    } else {
                    $weite = 0;
                        $prozent = 0;
                    }
                        $tbweite = $weite + 20;
                        echo '&lt;tr&gt;&lt;td width="30%"&gt;'.$pollRow-&gt;antw.'&lt;/td&gt;';
                    echo '&lt;td width="50%"&gt;';
            /*
            '&lt;table width="'.$tbweite.'" border="0" cellpadding="0" cellspacing="0"&gt;&lt;/td&gt;';
                        echo '&lt;tr&gt;&lt;td width="10" height="10"&gt;&lt;/td&gt;';
                        echo '&lt;td width="'.$weite.'" background="include/images/vote/voteMitte.jpg" alt=""&gt;&lt;/td&gt;';
                        echo '&lt;td width="10"&gt;&lt;img src="include/images/vote/voteRight.jpg" alt=""&gt;&lt;/td&gt;';
                        echo '&lt;/tr&gt;&lt;/table&gt;';*/
            echo '&lt;div style="height: 10px; width: ' . $weite .'px; background: #3776a5 url(include/images/vote/voteMitte.png) repeat-y top left;"&gt;'.
                 '&lt;/div&gt;';
                    
            echo '&lt;td width="10%"&gt;'.$prozent.'%&lt;/td&gt;';
                    echo '&lt;td width="20%" align="right"&gt;'.$pollRow-&gt;res.'&lt;/td&gt;&lt;/tr&gt;';
                } else {
            $i++;
                  echo '&lt;input type="radio" id="vote'.$i.'" name="radio" value="'.$pollRow-&gt;sort.'"&gt;&lt;label for="vote'.$i.'"&gt; '.$pollRow-&gt;antw.'&lt;/label&gt;&lt;br&gt;';
            }
        } 
        if ( $imPollArrayDrin ) {
              echo '&lt;tr&gt;&lt;td colspan="2" align="right"&gt;'.$lang['whole'].': &amp;nbsp; '.$ges.'&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';
        } else {
            echo '&lt;p align="center"&gt;&lt;input type="submit" value="'.$lang['formsub'].'"&gt;&lt;/p&gt;&lt;/form&gt;';
        }
        
    echo '&lt;/td&gt;&lt;/tr&gt;';
<a name="diff" id="c12"><span class="HDDeleted">        
</span></a><span class="HDAdded">    }
</span>}<span class="HDDeleted"> </span>// end while

echo '&lt;tr&gt;&lt;td class="Cdark" align="center"&gt;'. $MPL .'&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';
$design-&gt;footer();

?&gt;</span></pre>
  <br><b><a name="#box">include/boxes/vote.php</a></b>
  <pre><span class="HDNormal">&lt;?php 
#   Copyright by Manuel Staechele
#   Support www.ilch.de
<a name="diff" id="c0"><span class="HDAdded">#   Modified by Mairu -&gt; Erweiterte Umfrage 1.3
#   include/boxes/vote.php
</span></a>

defined ('main') or die ( 'no direct access' );


//-----------------------------------------------------------|
// Vote Sperre in Stunden

$stunden = 24;

    $breite = 50;
    $diftime = time() - (60 * 60 * $stunden);
        
<a name="diff" id="c1"><span class="HDDeleted">    if ( has_right(-1) ) {
</span></a><span class="HDDeleted">      $woR = '&gt;= "1"';
</span><span class="HDDeleted">    } else {
</span><span class="HDDeleted">      $woR = '= "1"';
</span><span class="HDAdded">    $voted = array();
</span><span class="HDAdded">    
</span><span class="HDAdded">  $fraErg = db_query('SELECT * FROM `prefix_poll` WHERE stat = 1 ORDER BY poll_id DESC');
</span><span class="HDAdded">    
</span><span class="HDAdded">  if ( db_num_rows($fraErg) &gt; 0) {
</span><span class="HDAdded">    $pollid = 0;
</span><span class="HDAdded">  while ($fraRow = db_fetch_object($fraErg)) { 
</span><span class="HDAdded">    
</span><span class="HDAdded">    if ($fraRow-&gt;recht == 2) {
</span><span class="HDAdded">          $inTextAr = $_SESSION['authid'];
</span><span class="HDAdded">        } elseif ($fraRow-&gt;recht == 1) {
</span><span class="HDAdded">          $inTextAr = $_SERVER['REMOTE_ADDR'];
</span>    }
    
<a name="diff" id="c2"><span class="HDDeleted">    $fraErg = db_query('SELECT * FROM `prefix_poll` WHERE recht '.$woR.' ORDER BY poll_id DESC LIMIT 1');
</span></a><span class="HDAdded">        $textAr = explode('#',$fraRow-&gt;text);
</span><span class="HDAdded">        if ( in_array ( $inTextAr , $textAr )) {
</span><span class="HDAdded">            $imPollArrayDrin = true;
</span><span class="HDAdded">        } else {
</span><span class="HDAdded">            $imPollArrayDrin = false;
</span><span class="HDAdded">        }
</span> 
<a name="diff" id="c3"><span class="HDAdded">    if (!$imPollArrayDrin OR (count($tovote) == 0 AND $fraRow-&gt;view &gt;= $_SESSION['authright']) OR $fraRow-&gt;view &gt;= $_SESSION['authright']) {
      if ($fraRow-&gt;recht == 2) { 
        if ($fraRow-&gt;user_rechte == '') $fraRow-&gt;user_rechte = '0123456789';
        if (!empty($fraRow-&gt;groups)) {
          $votegroups = explode('#', $fraRow-&gt;groups);
              foreach ($_SESSION['authgrp'] as $id =&gt; $authgroup) if (in_array($id, $votegroups)) $abstimmen = true;
              if (strpos($fraRow-&gt;user_rechte,''.abs($_SESSION['authright'])) === false) $abstimmen = false;
          }
        elseif (strpos($fraRow-&gt;user_rechte,''.abs($_SESSION['authright'])) !== false) {
          $abstimmen = true;
        }
      } else {
        if (!$imPollArrayDrin) $abstimmen = true;
        else $abstimmen = false;        
      }
</span></a>  
<a name="diff" id="c4"><span class="HDAdded">      if ($abstimmen AND !$imPollArrayDrin) {
        $pollid = $fraRow-&gt;poll_id;
        break;
      } else {
        $voted[] = $fraRow-&gt;poll_id;
        }
      }
    }
  }
</span></a>    
<a name="diff" id="c5"><span class="HDDeleted">    if ( db_num_rows($fraErg) &gt; 0) {
</span></a><span class="HDAdded">  if ($pollid == 0 AND count($voted) &gt; 0) {
</span><span class="HDAdded">    $pollid = $voted[array_rand($voted,1)];
</span><span class="HDAdded">  }
</span>    
<a name="diff" id="c6"><span class="HDAdded">  if ($pollid != 0) {
    $fraErg = db_query('SELECT * FROM `prefix_poll` WHERE recht '.$woR.' AND poll_id = '.$pollid.' ORDER BY poll_id DESC LIMIT 1');
</span></a>    $fraRow = db_fetch_object($fraErg);
<a name="diff" id="c7"><span class="HDDeleted">    if ( $fraRow-&gt;stat == 1 ) { 
</span></a>        
    $maxRow = db_fetch_object(db_query('SELECT MAX(res) as res FROM `prefix_poll_res` WHERE poll_id = "'.$fraRow-&gt;poll_id.'"'));
    $gesErg = db_query('SELECT SUM(res) as res FROM `prefix_poll_res` WHERE poll_id = "'.$fraRow-&gt;poll_id.'"');
    $gesRow = db_fetch_object($gesErg);
    
    
    $max = $maxRow-&gt;res;
  $ges = $gesRow-&gt;res;
    $textAr = explode('#',$fraRow-&gt;text);
    
      if ($fraRow-&gt;recht == 2) {
          $inTextAr = $_SESSION['authid'];
        } elseif ($fraRow-&gt;recht == 1) {
          $inTextAr = $_SERVER['REMOTE_ADDR'];
        }
        
        echo '&lt;b&gt;'.$fraRow-&gt;frage.'&lt;/b&gt;';
<a name="diff" id="c8"><span class="HDAdded">        if ($fraRow-&gt;exptime &gt; 0) {
      echo '&lt;br /&gt;&lt;small&gt;(bis '.date('H.i \U\h\r - d.m.Y',$fraRow-&gt;exptime).')&lt;/small&gt;';
    }
</span></a>        if ( in_array ( $inTextAr , $textAr ) OR $fraRow-&gt;stat == 0) {
              echo '&lt;table width="100%" cellpadding="0"&gt;';
            $imPollArrayDrin = true;
        } else {
              echo '&lt;form action="index.php?vote-W'.$fraRow-&gt;poll_id.'" method="POST"&gt;';
            $imPollArrayDrin = false;
        }
        $i = 0;
    $pollErg = db_query('SELECT antw, res, sort FROM `prefix_poll_res` WHERE poll_id = "'.$fraRow-&gt;poll_id.'" ORDER BY sort');
        while ( $pollRow = db_fetch_object($pollErg) ) {
            if ( $imPollArrayDrin ) {
                        echo '&lt;tr&gt;&lt;td&gt;'.$pollRow-&gt;antw.'&lt;/td&gt;&lt;td align="right"&gt;'.$pollRow-&gt;res.'<a name="diff" id="c9"><span class="HDAdded"> ('.round($pollRow-&gt;res/$ges*100,1).'%)</span></a>&lt;/td&gt;&lt;/tr&gt;';
            } else {
                  $i++;
            echo '&lt;input type="radio" id="vote'.$i.'" name="radio" value="'.$pollRow-&gt;sort.'"&gt;&lt;label for="vote'.$i.'"&gt; '.$pollRow-&gt;antw.'&lt;/label&gt;&lt;br&gt;';
            }
        } 
        if ( $imPollArrayDrin ) {
              echo '&lt;tr&gt;&lt;td colspan="2" align="right"&gt;'.$lang['whole'].': &amp;nbsp; '.$ges.'&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;';
        } else {
            echo '&lt;p align="center"&gt;&lt;input type="submit" value="'.$lang['formsub'].'"&gt;&lt;/p&gt;&lt;/form&gt;';
        }   
        } else {
          echo $lang['nowvoteavailable'];
        }
<a name="diff" id="c10"><span class="HDDeleted">        } else {
          echo $lang['nowvoteavailable'];
        }
</span></a>
?&gt;</span></pre>
  </body>
</html>
